<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Preparation Assistant</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Exam Preparation Assistant</h1>
            <p>Your personal tool for effective exam preparation</p>
            <div id="auth-buttons">
                <button id="login-btn" onclick="showLoginModal()">Login</button>
                <button id="register-btn" onclick="showRegisterModal()">Register</button>
                <div id="user-info" style="display: none;">
                    <span id="username-display"></span>
                    <button onclick="logout()">Logout</button>
                </div>
            </div>
        </header>
        
        <!-- Auth Modals -->
        <div id="login-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('login-modal')">&times;</span>
                <h2>Login</h2>
                <div id="login-error" class="error-message"></div>
                <form id="login-form">
                    <input type="text" id="login-username" placeholder="Username" required>
                    <input type="password" id="login-password" placeholder="Password" required>
                    <button type="submit">Login</button>
                </form>
            </div>
        </div>

        <div id="register-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('register-modal')">&times;</span>
                <h2>Register</h2>
                <div id="register-error" class="error-message"></div>
                <form id="register-form">
                    <input type="text" id="register-username" placeholder="Username" required>
                    <input type="email" id="register-email" placeholder="Email (optional)">
                    <input type="password" id="register-password" placeholder="Password" required>
                    <button type="submit">Register</button>
                </form>
            </div>
        </div>
        
        <ul class="nav-tabs">
            <li><a href="#study" class="active" onclick="switchTab('study')">Study</a></li>
            <li><a href="#quiz" onclick="switchTab('quiz')">Take Quiz</a></li>
            <li><a href="#progress" onclick="switchTab('progress')">Progress</a></li>
            <li><a href="#recommendations" onclick="switchTab('recommendations')">Recommendations</a></li>
        </ul>
        
        <!-- Study Tab -->
        <div id="study" class="tab-content active">
            <div class="card">
                <h2>Plan Your Study Session</h2>
                <div class="filters">
                    <select id="study-subject">
                        <option value="All">All Subjects</option>
                        <option value="Math">Math</option>
                        <option value="Science">Science</option>
                        <option value="History">History</option>
                    </select>
                    
                    <select id="study-topic">
                        <option value="All">All Topics</option>
                        <option value="Algebra">Algebra</option>
                        <option value="Geometry">Geometry</option>
                        <option value="Physics">Physics</option>
                        <option value="Chemistry">Chemistry</option>
                        <option value="World">World History</option>
                        <option value="US">US History</option>
                    </select>
                    
                    <select id="study-difficulty">
                        <option value="All">All Difficulty</option>
                        <option value="Easy">Easy</option>
                        <option value="Medium">Medium</option>
                        <option value="Hard">Hard</option>
                    </select>
                    
                    <input type="number" id="study-time" placeholder="Study time (min)" min="5" value="30">
                    
                    <button onclick="startStudySession()">Start Session</button>
                </div>
            </div>
            
            <div class="card">
                <h2>Recent Study Sessions</h2>
                <div id="study-sessions-list">
                    <p>No study sessions recorded yet.</p>
                </div>
            </div>
        </div>
        
        <!-- Quiz Tab -->
        <div id="quiz" class="tab-content">
            <div class="card">
                <h2>Practice Quiz</h2>
                <div class="filters">
                    <select id="quiz-subject">
                        <option value="All">All Subjects</option>
                        <option value="Math">Math</option>
                        <option value="Science">Science</option>
                        <option value="History">History</option>
                    </select>
                    
                    <select id="quiz-topic">
                        <option value="All">All Topics</option>
                        <option value="Algebra">Algebra</option>
                        <option value="Geometry">Geometry</option>
                        <option value="Physics">Physics</option>
                        <option value="Chemistry">Chemistry</option>
                        <option value="World">World History</option>
                        <option value="US">US History</option>
                    </select>
                    
                    <select id="quiz-difficulty">
                        <option value="All">All Difficulty</option>
                        <option value="Easy">Easy</option>
                        <option value="Medium">Medium</option>
                        <option value="Hard">Hard</option>
                    </select>
                    
                    <select id="quiz-limit">
                        <option value="5">5 Questions</option>
                        <option value="10" selected>10 Questions</option>
                        <option value="15">15 Questions</option>
                        <option value="20">20 Questions</option>
                    </select>
                    
                    <button onclick="loadQuiz()">Load Questions</button>
                </div>
            </div>
            
            <div id="quiz-container"></div>
        </div>
        
        <!-- Progress Tab -->
        <div id="progress" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Questions Answered</h3>
                    <div class="stat-value" id="total-questions">0</div>
                    <p>Keep practicing!</p>
                </div>
                
                <div class="stat-card">
                    <h3>Overall Accuracy</h3>
                    <div class="stat-value" id="overall-accuracy">0%</div>
                    <p>Across all subjects</p>
                </div>
                
                <div class="stat-card">
                    <h3>Study Time</h3>
                    <div class="stat-value" id="total-study-time">0h</div>
                    <p>Total time spent studying</p>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>Performance by Topic</h3>
                <canvas id="performance-chart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>Recent Performance</h3>
                <canvas id="trend-chart"></canvas>
            </div>
        </div>
        
        <!-- Recommendations Tab -->
        <div id="recommendations" class="tab-content">
            <div class="card">
                <h2>Study Recommendations</h2>
                <div id="recommendations-list">
                    <p>Loading recommendations...</p>
                </div>
            </div>
            
            <div class="card">
                <h2>Weak Areas</h2>
                <div class="chart-container">
                    <img id="weak-areas-chart" src="/api/performance-chart" alt="Performance by Topic">
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let selectedOption = null;
        let isLoggedIn = false;
        
        // Check authentication status on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
        });
        
        // Authentication functions
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/user');
                if (response.ok) {
                    const userData = await response.json();
                    isLoggedIn = true;
                    document.getElementById('auth-buttons').style.display = 'none';
                    document.getElementById('user-info').style.display = 'block';
                    document.getElementById('username-display').textContent = `Welcome, ${userData.username}`;
                } else {
                    isLoggedIn = false;
                    document.getElementById('auth-buttons').style.display = 'flex';
                    document.getElementById('user-info').style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking auth status:', error);
            }
        }
        
        function showLoginModal() {
            document.getElementById('login-modal').style.display = 'block';
        }
        
        function showRegisterModal() {
            document.getElementById('register-modal').style.display = 'block';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                if (response.ok) {
                    closeModal('login-modal');
                    checkAuthStatus();
                    // Clear form
                    document.getElementById('login-form').reset();
                    document.getElementById('login-error').textContent = '';
                } else {
                    const errorData = await response.json();
                    document.getElementById('login-error').textContent = errorData.error || 'Login failed';
                }
            } catch (error) {
                console.error('Login error:', error);
                document.getElementById('login-error').textContent = 'Login failed. Please try again.';
            }
        });
        
        document.getElementById('register-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            try {
                const response = await fetch('/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, email, password })
                });
                
                if (response.ok) {
                    closeModal('register-modal');
                    // Auto-login after registration
                    const loginResponse = await fetch('/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username, password })
                    });
                    
                    if (loginResponse.ok) {
                        checkAuthStatus();
                    }
                    // Clear form
                    document.getElementById('register-form').reset();
                    document.getElementById('register-error').textContent = '';
                } else {
                    const errorData = await response.json();
                    document.getElementById('register-error').textContent = errorData.error || 'Registration failed';
                }
            } catch (error) {
                console.error('Registration error:', error);
                document.getElementById('register-error').textContent = 'Registration failed. Please try again.';
            }
        });
        
        async function logout() {
            try {
                const response = await fetch('/logout');
                if (response.ok) {
                    isLoggedIn = false;
                    checkAuthStatus();
                }
            } catch (error) {
                console.error('Logout error:', error);
            }
        }
        
        // Tab switching
        function switchTab(tabName) {
            if (!isLoggedIn && tabName !== 'study') {
                alert('Please log in to access this feature');
                showLoginModal();
                return;
            }
            
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tabs a').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`a[href="#${tabName}"]`).classList.add('active');
            
            // Load data when switching to specific tabs
            if (tabName === 'progress') {
                loadProgressData();
            } else if (tabName === 'recommendations') {
                loadRecommendations();
                // Refresh the performance chart
                document.getElementById('weak-areas-chart').src = '/api/performance-chart?' + new Date().getTime();
            } else if (tabName === 'study') {
                loadStudySessions();
            }
        }
        
        // Study session functions
        function startStudySession() {
            if (!isLoggedIn) {
                alert('Please log in to record study sessions');
                showLoginModal();
                return;
            }
            
            const subject = document.getElementById('study-subject').value;
            const topic = document.getElementById('study-topic').value;
            const duration = parseInt(document.getElementById('study-time').value);
            
            if (!duration || duration < 5) {
                alert('Please enter a valid study time (at least 5 minutes)');
                return;
            }
            
            fetch('/api/study-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    subject: subject,
                    topic: topic,
                    duration: duration
                })
            })
            .then(response => response.json())
            .then(data => {
                alert('Study session recorded!');
                loadStudySessions();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to record study session');
            });
        }
        
        function loadStudySessions() {
            if (!isLoggedIn) return;
            
            fetch('/api/study-sessions')
                .then(response => response.json())
                .then(data => {
                    const sessionsList = document.getElementById('study-sessions-list');
                    document.getElementById('total-study-time').textContent = data.total_study_time;
                    
                    if (data.sessions.length === 0) {
                        sessionsList.innerHTML = '<p>No study sessions recorded yet.</p>';
                        return;
                    }
                    
                    let html = '<div class="sessions-container">';
                    data.sessions.reverse().forEach(session => {
                        const date = new Date(session.date).toLocaleDateString();
                        html += `
                            <div class="session-item">
                                <strong>${session.subject} - ${session.topic}</strong>
                                <span>${session.duration} minutes on ${date}</span>
                            </div>
                        `;
                    });
                    html += '</div>';
                    sessionsList.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('study-sessions-list').innerHTML = '<p>Error loading study sessions</p>';
                });
        }
        
        // Quiz functions
        function loadQuiz() {
            if (!isLoggedIn) {
                alert('Please log in to take quizzes');
                showLoginModal();
                return;
            }
            
            const subject = document.getElementById('quiz-subject').value;
            const topic = document.getElementById('quiz-topic').value;
            const difficulty = document.getElementById('quiz-difficulty').value;
            const limit = document.getElementById('quiz-limit').value;
            
            fetch(`/api/questions?subject=${subject}&topic=${topic}&difficulty=${difficulty}&limit=${limit}`)
                .then(response => response.json())
                .then(questions => {
                    currentQuestions = questions;
                    currentQuestionIndex = 0;
                    selectedOption = null;
                    displayQuestion();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to load questions');
                });
        }
        
        function displayQuestion() {
            if (currentQuestionIndex >= currentQuestions.length) {
                // Quiz completed
                document.getElementById('quiz-container').innerHTML = `
                    <div class="card">
                        <h2>Quiz Completed!</h2>
                        <p>You've answered all questions.</p>
                        <button onclick="loadQuiz()">Start New Quiz</button>
                    </div>
                `;
                return;
            }
            
            const question = currentQuestions[currentQuestionIndex];
            const optionsHtml = question.options.map((option, index) => `
                <div class="option" onclick="selectOption(${index})">
                    ${option}
                </div>
            `).join('');
            
            document.getElementById('quiz-container').innerHTML = `
                <div class="card">
                    <div class="question-container">
                        <h3>Question ${currentQuestionIndex + 1} of ${currentQuestions.length}</h3>
                        <p>${question.question}</p>
                        <div class="options">
                            ${optionsHtml}
                        </div>
                    </div>
                    <button onclick="submitAnswer()" id="submit-btn" disabled>Submit Answer</button>
                    <div id="feedback"></div>
                </div>
            `;
        }
        
        function selectOption(index) {
            selectedOption = index;
            document.querySelectorAll('.option').forEach((opt, i) => {
                if (i === index) {
                    opt.classList.add('selected');
                } else {
                    opt.classList.remove('selected');
                }
            });
            document.getElementById('submit-btn').disabled = false;
        }
        
        function submitAnswer() {
            if (selectedOption === null) return;
            
            const question = currentQuestions[currentQuestionIndex];
            const selectedAnswer = question.options[selectedOption];
            
            fetch('/api/answer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    question_id: question.id,
                    answer: selectedAnswer
                })
            })
            .then(response => response.json())
            .then(result => {
                const feedback = document.getElementById('feedback');
                
                // Mark correct and incorrect options
                document.querySelectorAll('.option').forEach((opt, i) => {
                    if (question.options[i] === result.correct_answer) {
                        opt.classList.add('correct');
                    } else if (i === selectedOption && !result.is_correct) {
                        opt.classList.add('incorrect');
                    }
                });
                
                // Show feedback
                feedback.innerHTML = `
                    <div class="feedback ${result.is_correct ? 'correct' : 'incorrect'}">
                        ${result.is_correct ? 
                            '✓ Correct! Well done.' : 
                            `✗ Incorrect. The correct answer is ${result.correct_answer}.`}
                    </div>
                    <button onclick="nextQuestion()">Next Question</button>
                `;
                
                document.getElementById('submit-btn').disabled = true;
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to submit answer');
            });
        }
        
        function nextQuestion() {
            currentQuestionIndex++;
            displayQuestion();
        }
        
        // Progress functions
        function loadProgressData() {
            if (!isLoggedIn) return;
            
            fetch('/api/performance')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('total-questions').textContent = 
                        data.answered_questions_count || 0;
                    document.getElementById('overall-accuracy').textContent = 
                        `${Math.round((data.overall_accuracy || 0) * 100)}%`;
                    
                    // Create performance chart
                    createPerformanceChart(data.by_topic || {});
                    createTrendChart(data.by_date || {});
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to load progress data');
                });
        }
        
        function createPerformanceChart(performanceData) {
            const ctx = document.getElementById('performance-chart').getContext('2d');
            
            const topics = Object.keys(performanceData);
            if (topics.length === 0) {
                document.getElementById('performance-chart').parentElement.innerHTML = `
                    <h3>Performance by Topic</h3>
                    <p>No data available yet. Complete some quizzes first.</p>
                `;
                return;
            }
            
            const accuracy = topics.map(topic => performanceData[topic]);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topics,
                    datasets: [{
                        label: 'Accuracy (%)',
                        data: accuracy.map(acc => acc * 100),
                        backgroundColor: 'rgba(67, 97, 238, 0.5)',
                        borderColor: 'rgba(67, 97, 238, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createTrendChart(trendData) {
            const ctx = document.getElementById('trend-chart').getContext('2d');
            
            const dates = Object.keys(trendData).sort();
            if (dates.length === 0) {
                document.getElementById('trend-chart').parentElement.innerHTML = `
                    <h3>Recent Performance</h3>
                    <p>No data available yet. Complete some quizzes first.</p>
                `;
                return;
            }
            
            const accuracy = dates.map(date => trendData[date] * 100);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Daily Accuracy (%)',
                        data: accuracy,
                        fill: false,
                        backgroundColor: 'rgba(76, 201, 240, 0.5)',
                        borderColor: 'rgba(76, 201, 240, 1)',
                        tension: 0.1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Recommendations functions
        function loadRecommendations() {
            if (!isLoggedIn) return;
            
            fetch('/api/recommendations')
                .then(response => response.json())
                .then(data => {
                    const recList = document.getElementById('recommendations-list');
                    recList.innerHTML = '';
                    
                    if (data.recommendations.length === 0) {
                        recList.innerHTML = '<p>No recommendations available yet. Complete some quizzes first.</p>';
                        return;
                    }
                    
                    data.recommendations.forEach(rec => {
                        const recElement = document.createElement('div');
                        recElement.className = 'recommendation';
                        recElement.textContent = rec;
                        recList.appendChild(recElement);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('recommendations-list').innerHTML = '<p>Error loading recommendations</p>';
                });
        }
    </script>
</body>
</html>